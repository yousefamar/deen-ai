<!DOCTYPE html>
<html>

<head>
  <title>deen.ai</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <script src="https://unpkg.com/canvas-txt@3.0.0/build/index.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');

    * {
      font-family: 'Kanit', sans-serif;
    }
  
    /* https://coolors.co/palette/eef0f2-c8c9cb-bee8e5-3d736e-1e3937 */
    :root {
      --background-body: #1e3937;
      --background: #1e3937;
      --background-alt: #3d736e;
      --text-main: #c8c9cb;
      --text-bright: #eef0f2;
      --text-muted: #c8c9cb;
      --form-placeholder: #6d6e70;
      --scrollbar-thumb: #c8c9cb;
      --scrollbar-thumb-hover: #eef0f2;
      --links: #bee8e5;
      --focus: #a9b0b3;
      --border: #a9b0b3;
      --button-hover: #a9b0b3;
      --content-width: min(calc(100vw - 2rem), 800px);
      --button-base: #3d736e;
    }

    textarea, input {
      border: 1px solid var(--border);
    }

    button {
      border-radius: 9999px;
    }

    .content {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .flex-row {
      display: flex;
      flex-direction: row;
    }
    .flex-col {
      display: flex;
      flex-direction: column;
    }
    .w-full {
      width: 100%;
    }
    .justify-center {
      justify-content: center;
    }
    .items-center {
      align-items: center;
    }

    .hidden {
      display: none;
    }

    canvas {
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

  </style>

</head>

<body>
  <img src="logo-with-text.svg" style="height: 2.5em;"/>

  <div style="position: relative; width: 100%;">
    <div id="page-1" class="content">
      <p>I am an AI trained on the Qur'an, hadiths, and thousands of scholarly texts. Please ask me anything! But keep in mind that I'm still learning and may struggle with complex topics, so please follow up with humans!</p>
      <div class="flex-col w-full">
        <textarea id="prompt" name="prompt" type="text" placeholder="e.g. &quot;What does Islam say about AI?&quot;"
          autofocus></textarea>
        <div class="flex-row justify-center w-full" style="margin-top: 16px;">
          <button id="askButton" style="flex-grow: 1; max-width: 400px;" disabled>Ask</button>
        </div>
      </div>
    </div>
  

    <div id="page-2" class="content hidden">
      <div class="w-full flex-col items-center htmx-indicator" style="padding: 16px;">
        <img width="64" height="64" src="puff.svg">
        <p style="display: inline;">Thinking...</p>
      </div>
    </div>

    <div id="page-3" class="content hidden">
      <!-- <p id="answer"></p> -->
      <canvas id="shareCanvas" width="1080" height="1080"></canvas>
      <div class="flex-row justify-center w-full" style="margin-top: 16px;">
        <button id="shareButton" style="flex-grow: 1; max-width: 400px;">Share</button>
      </div>
      <div class="flex-row justify-center w-full" style="margin-top: 16px;">
        <button id="retryButton" style="flex-grow: 1; max-width: 400px;">Ask again</button>
      </div>
      <!-- <div id="mc_embed_signup">
        <form
          action="https://deen.us21.list-manage.com/subscribe/post?u=048d7c09b5ea13b09579d6fa1&amp;id=51d2c0ad23&amp;f_id=0042d6e1f0"
          method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_self">
          <div id="mc_embed_signup_scroll">
      
            <div class="mc-field-group">
              <label for="mce-EMAIL">Email Address</label>
              <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required>
              <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span>
            </div>
            <div id="mce-responses" class="clear foot">
              <div class="response" id="mce-error-response" style="display:none"></div>
              <div class="response" id="mce-success-response" style="display:none"></div>
            </div>
            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text"
                name="b_048d7c09b5ea13b09579d6fa1_51d2c0ad23" tabindex="-1" value=""></div>
            <div class="optionalParent">
              <div class="clear foot">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
              </div>
            </div>
          </div>
        </form>
      </div> -->
    </div>
  
  </div>

  <script>
    document.getElementById('prompt').addEventListener('input', () => {
      const prompt = document.getElementById('prompt').value;
      document.getElementById('askButton').disabled = prompt.length == 0;
    });

    document.getElementById('retryButton').addEventListener('click', e => {
      e.preventDefault();
      document.getElementById('page-3').classList.add('hidden');
      document.getElementById('page-1').classList.remove('hidden');
      document.getElementById('prompt').focus();
      document.getElementById('askButton').disabled = false;
    });

    function dataURItoBlob(dataURI) {
      const binary = atob(dataURI.split(',')[1]);
      const array = [];
      for (let i = 0; i < binary.length; i++)
        array.push(binary.charCodeAt(i));
      return new Blob([new Uint8Array(array)], { type: 'image/png' });
    }

    document.getElementById('shareButton').addEventListener('click', e => {
      e.preventDefault();

      const canvas = document.getElementById('shareCanvas');
      const dataURL = canvas.toDataURL('image/png');

      if (navigator.share) {
        const blob = dataURItoBlob(dataURL);
        navigator.share({
          title: 'deen.ai',
          text: 'deen.ai, an islamic AI, answered my question!',
          files: [ blob ],
        });
      } else {
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = 'deen-ai.png';
        a.click();
      }
    });

    const computeFontSize = (ctx, text, x, y, width, maxHeight) => {
      const canvasTxt = window.canvasTxt.default
      let fontSize = 100;
      canvasTxt.fontSize = fontSize;

      let h;
      do {
        fontSize -= 10;
        canvasTxt.fontSize = fontSize;
        const { height } = canvasTxt.drawText(ctx, text, 40, 40, 1000, maxHeight);
        h = height;
      } while (h > maxHeight);

      return [ fontSize, h ];
    };

    const renderShareCanvas = (prompt, answer) => new Promise(resolve => {
      const canvas = document.getElementById('shareCanvas');
      const ctx = canvas.getContext('2d');

      const img = new Image();
      img.src = 'share-template.png';
      img.onload = () => {
        ctx.fillStyle = '#eef0f2';
        ctx.textAlign = 'center';
        const canvasTxt = window.canvasTxt.default
        canvasTxt.font = 'Kanit';

        const [ fontSizePrompt ] = computeFontSize(ctx, prompt, 40, 40, 1000, 210);
        const [ fontSizeAnswer, heightAnswer ] = computeFontSize(ctx, answer, 40, 350, 1000, 640);

        ctx.drawImage(img, 0, 0);

        // ctx.strokeStyle = '#f00';
        // ctx.lineWidth = 1;
        // ctx.strokeRect(40, 40, 1000, 210);
        // ctx.strokeRect(40, 350, 1000, 640);

        ctx.fillStyle = '#c8c9cb';
        canvasTxt.fontSize = fontSizePrompt;
        canvasTxt.drawText(ctx, prompt, 40, 40, 1000, 210);
        ctx.fillStyle = '#eef0f2';
        canvasTxt.fontSize = fontSizeAnswer;
        canvasTxt.drawText(ctx, answer, 40, 350, 1000, heightAnswer);

        resolve();
      }
    });

    document.getElementById('askButton').addEventListener('click', async e => {
      e.preventDefault();

      document.getElementById('page-1').classList.add('hidden');
      document.getElementById('page-2').classList.remove('hidden');

      const promptEl = document.getElementById('prompt');
      const prompt = promptEl.value;
      // promptEl.value = '';
      // document.getElementById('askButton').disabled = true;
      let answer;

      try {
        const response = await fetch('https://red.amar.io/deen/prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt }),
        });

        answer = await response.text();
        // document.getElementById('answer').innerText = answer;
      } catch (error) {
        console.error(error);
        alert("Something went wrong! Please try again.");
        document.getElementById('page-2').classList.add('hidden');
        document.getElementById('page-1').classList.remove('hidden');
        return;
      }

      await renderShareCanvas(prompt, answer);

      document.getElementById('page-2').classList.add('hidden');
      document.getElementById('page-3').classList.remove('hidden');
    });

  </script>
</body>